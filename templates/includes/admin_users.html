<h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>

<div class="mb-3 d-flex justify-content-between align-items-center">
  <div class="d-flex gap-2">
    <a href="{{ url_for('add_user') }}" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    <a href="{{ url_for('export_users') }}" class="btn btn-outline-primary">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a>
    <button type="button" class="btn btn-outline-success" onclick="document.getElementById('importExcelInput').click();">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
  </div>
</div>

<form id="importExcelForm" action="{{ url_for('import_users') }}" method="POST" enctype="multipart/form-data" style="display: none;">
  <input type="file" id="importExcelInput" name="file" accept=".xlsx" onchange="document.getElementById('importExcelForm').submit();">
</form>

{% with toast_message = request.cookies.get('toast_message'), toast_category = request.cookies.get('toast_category') %}
  {% if toast_message %}
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div class="toast align-items-center text-white bg-{{ toast_category or 'info' }} border-0 show" role="alert">
        <div class="d-flex">
          <div class="toast-body">
            {{ toast_message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
      </div>
    </div>
  {% endif %}
{% endwith %}

<form method="POST" id="users-form">
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-danger" id="deleteConfirmButton">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <table id="users-table" class="table table-striped table-bordered align-middle">
    <thead>
      <tr>
        <th>–§–∞–º–∏–ª–∏—è</th>
        <th>–ò–º—è</th>
        <th>–õ–æ–≥–∏–Ω</th>
        <th>–ü–∞—Ä–æ–ª—å</th>
        <th>–†–æ–ª—å</th>
        <th>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr class="{% if user.is_blocked %}table-danger{% elif user.role == 'admin' %}table-primary{% elif user.role == 'manager' %}table-success{% elif user.role == 'worker' %}table-warning{% endif %}">
        <td><input type="text" name="users[{{ user.id }}][last_name]" class="form-control" value="{{ user.last_name }}" title="–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"></td>
        <td><input type="text" name="users[{{ user.id }}][first_name]" class="form-control" value="{{ user.first_name }}" title="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"></td>
        <td><input type="text" name="users[{{ user.id }}][username]" class="form-control" value="{{ user.username }}" title="–õ–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞"></td>
        <td><input type="text" name="users[{{ user.id }}][password]" class="form-control" value="{{ user.temp_password or '' }}" placeholder="–ü–∞—Ä–æ–ª—å –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å" title="–ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å, –æ–Ω –∑–¥–µ—Å—å, –∏–Ω–∞—á–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ"></td>
        <td>
          <select name="users[{{ user.id }}][role]" class="form-select role-select" data-initial="{{ user.role }}" title="–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω</option>
            <option value="manager" {% if user.role == 'manager' %}selected{% endif %}>–ê–£–ü</option>
            <option value="worker" {% if user.role == 'worker' %}selected{% endif %}>–†–∞–±–æ—á–∏–π</option>
            <option value="new" {% if user.role == 'new' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç</option>
          </select>
        </td>
        <td class="text-center">
          <input type="checkbox" name="users[{{ user.id }}][is_blocked]" {% if user.is_blocked %}checked{% endif %} title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω">
        </td>
        <td>
          {% if user.id != current_user.id %}
          <button type="submit" name="action" value="save_{{ user.id }}" class="btn btn-primary btn-sm d-none">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" data-bs-toggle="modal" data-bs-target="#deleteModal" class="btn btn-danger btn-sm" data-user-id="{{ user.id }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          {% else %}
          <span class="text-muted">–í—ã</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function () {
  $('#users-table').DataTable({
    language: {
      search: "–ü–æ–∏—Å–∫:",
      lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É",
      zeroRecords: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
      info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_‚Äì_END_ –∏–∑ _TOTAL_ –∑–∞–ø–∏—Å–µ–π",
      infoEmpty: "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π",
      infoFiltered: "(–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∏–∑ _MAX_ –∑–∞–ø–∏—Å–µ–π)",
      paginate: {
        first: "–ü–µ—Ä–≤–∞—è",
        last: "–ü–æ—Å–ª–µ–¥–Ω—è—è",
        next: "–°–ª–µ–¥—É—é—â–∞—è",
        previous: "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
      }
    },
    ordering: false,
    order: [[0, 'asc']],
    stateSave: true,
  });

  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });

  $('#users-table tbody').on('input change', 'input, select', function() {
    var $row = $(this).closest('tr');
    var $saveBtn = $row.find('button[type="submit"][name^="action"][value^="save_"]');
    if ($saveBtn.length) {
      $saveBtn.removeClass('d-none');
    }
  });

  $('#deleteModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var userId = button.data('user-id');
    $(this).data('user-id', userId);
  });

  $('#deleteConfirmButton').off('click').on('click', function () {
    var modal = $('#deleteModal');
    var userId = modal.data('user-id');
    $('<form>', {
      method: 'POST',
      html: $('<input>', {
        type: 'hidden',
        name: 'action',
        value: 'delete_' + userId
      })
    }).appendTo('body').submit();
  });

  $('#users-table').on('change', '.role-select', function() {
    var newRole = $(this).val();
    var initialRole = $(this).data('initial');
    if (newRole === 'admin' && initialRole !== 'admin') {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?")) {
        $(this).val(initialRole);
      } else {
        $(this).data('initial', newRole);
      }
    }
  });
});
</script>
