{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h3>üîÄ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {{ file.name }}</h3>
    <form method="POST">
        <div class="mb-3">
            <label class="form-label">–í—ã–±—Ä–∞—Ç—å –æ–±—ä–µ–∫—Ç</label>
            <select name="facility_id" id="facility-select" class="form-select" required
                    data-selected-group="{{ file.group_id | tojson }}">
                {% for f in facilities %}
                    <option value="{{ f.id }}" {% if f.id == file.facility_id %}selected{% endif %}>{{ f.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">–ì—Ä—É–ø–ø–∞ —Ñ–∞–π–ª–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <select name="group_id" id="group-select" class="form-select">
                <option value="">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
        <a href="{{ url_for('facility_detail', facility_id=file.facility_id) }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
    </form>
</div>

<script>
    const facilitySelect = document.getElementById('facility-select');
    const groupSelect = document.getElementById('group-select');
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ (—Å—Ç—Ä–æ–∫–∞, —á–∏—Å–ª–æ –∏–ª–∏ null)
    const selectedGroupId = JSON.parse(facilitySelect.dataset.selectedGroup || 'null');

    async function loadGroups(facilityId, selectedGroupId = null) {
        const res = await fetch(`/api/facility/${facilityId}/groups`);
        const data = await res.json();
        groupSelect.innerHTML = '<option value="">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</option>';
        for (const group of data.groups) {
            const opt = document.createElement('option');
            opt.value = group.id;
            opt.textContent = group.name;
            // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ HTML ‚Äî —Å—Ç—Ä–æ–∫–∏
            if (selectedGroupId !== null && group.id === Number(selectedGroupId)) {
                opt.selected = true;
            }
            groupSelect.appendChild(opt);
        }
    }

    facilitySelect.addEventListener('change', () => {
        loadGroups(facilitySelect.value);
    });

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –∑–∞–≥—Ä—É–∑–∏–º –≥—Ä—É–ø–ø—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    loadGroups(facilitySelect.value, selectedGroupId);
</script>
{% endblock %}
